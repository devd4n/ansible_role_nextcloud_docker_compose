---
- name: Check if Docker is installed
  ansible.builtin.command:
    cmd: docker --version
  register: docker_check
  ignore_errors: true

- name: Fail if Docker is not installed
  ansible.builtin.fail:
    msg: "Docker is not installed! Please install Docker before running the Nextcloud setup role."
  when: docker_check.failed

- name: Check if Docker Compose plugin is installed
  ansible.builtin.command:
    cmd: docker compose version
  register: compose_check
  ignore_errors: true

- name: Fail if Docker Compose is not installed
  ansible.builtin.fail:
    msg: "Docker Compose is not installed! Please install Docker Compose (or the Docker Compose CLI) before running the Nextcloud setup role."
  when: compose_check.failed

- name: Ensure proxy network exists
  community.docker.docker_network:
    name: "{{ docker_nextcloud_proxy_network }}"
    state: present

- name: Ensure Nextcloud directories exist
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ docker_user | default(ansible_user) }}"
    group: "{{ docker_user | default(ansible_user) }}"
    mode: '0755'
    recurse: yes
  loop:
    - "{{ docker_compose_project_dir }}"
    - "{{ docker_nextcloud_www_dir }}"
    - "{{ docker_nextcloud_config_dir }}"
    - "{{ docker_nextcloud_data_dir }}"
    - "{{ docker_nextcloud_db_dir }}"

- name: Create docker-compose file
  template:
    src: docker-compose.yaml.j2
    dest: "{{ docker_compose_project_dir }}/docker-compose.yaml"
    mode: '0644'

#- name: Deploy Nextcloud stack
#  community.docker.docker_compose:
#    project_src: "{{ docker_compose_project_dir }}"
#    state: present
#    pull: "{{ docker_nextcloud_autoupdate_images | bool }}"
#    recreate: "{{ 'smart' if docker_nextcloud_autoupdate_images else 'never' }}"
#    remove_orphans: true

- name: Deploy Nextcloud stack with Docker Compose CLI
  ansible.builtin.command:
    cmd: docker compose up -d --pull
    chdir: "{{ docker_compose_project_dir }}"
  become: true

- name: Run Nextcloud cron every 5 minutes
  ansible.builtin.cron:
    name: "nextcloud cron"
    minute: "*/5"
    job: "docker exec -u www-data {{ docker_nextcloud_container_prefix }}-app php /var/www/html/cron.php"


